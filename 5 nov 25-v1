from ultralytics import YOLO
import cv2
import RPi.GPIO as GPIO
import time

# --- GPIO Setup ---
GPIO.setmode(GPIO.BCM)
GPIO_PIN = 27
GPIO.setup(GPIO_PIN, GPIO.OUT)
GPIO.output(GPIO_PIN, GPIO.HIGH)  # Start HIGH = no human
print("âœ… GPIO 27 initialized (HIGH = no human detected)")

# --- Load YOLO Model ---
model = YOLO("yolov8n.pt")

# --- Open Camera ---
cap = cv2.VideoCapture(0)
if not cap.isOpened():
    print("âŒ Camera not opened")
    GPIO.cleanup()
    exit()

print("ğŸ¥ Camera ready, starting detection...")

last_state = None
last_change_time = time.time()

try:
    while True:
        ret, frame = cap.read()
        if not ret:
            print("âš ï¸ Frame not captured")
            break

        # Run YOLO
        results = model(frame, verbose=False)
        humans = [box for box in results[0].boxes if int(box.cls[0]) == 0]
        count = len(humans)

        # Draw boxes
        for box in humans:
            x1, y1, x2, y2 = map(int, box.xyxy[0])
            cv2.rectangle(frame, (x1, y1), (x2, y2), (0, 255, 0), 2)

        detected = count > 0
        current_state = GPIO.LOW if detected else GPIO.HIGH

        # Only change GPIO after stable 2 seconds
        if current_state != last_state:
            last_change_time = time.time()
            last_state = current_state
        elif time.time() - last_change_time >= 2:
            GPIO.output(GPIO_PIN, current_state)
            print(f"{'ğŸ§ Human detected' if detected else 'ğŸŒ« No human'} â†’ GPIO 27 {'LOW (GND)' if detected else 'HIGH (3.3V)'}")

        # Display info
        cv2.putText(frame, f"Humans: {count}", (10, 40), cv2.FONT_HERSHEY_SIMPLEX, 1, (255, 255, 0), 2)
        cv2.imshow("YOLO Human Detection (Stable GPIO)", frame)
        if cv2.waitKey(1) & 0xFF == ord('q'):
            break

except KeyboardInterrupt:
    print("\nğŸ›‘ Stopped by user")

finally:
    cap.release()
    cv2.destroyAllWindows()
    GPIO.cleanup()
    print("âš™ï¸ GPIO cleaned up, exiting.")
